<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>ğŸ® æé€Ÿè½¦åº“æ˜¥èŠ‚ç‰ˆ - èµ¢å–ç§Ÿè½¦æƒç›Š</title>
    <style>
        /* --- æ˜¥èŠ‚ä¸»é¢˜å˜é‡ --- */
        :root {
            --spring-red: #d32f2f;
            --spring-red-light: #f44336;
            --spring-gold: #ffc107;
            --spring-gold-light: #ffeb3b;
            --spring-bg: #fff5f5;
            --spring-bg-dark: #ffebee;
        }

        /* --- åŸºç¡€æ ·å¼ --- */
        body { margin: 0; overflow: hidden; background: linear-gradient(135deg, #fff5f5 0%, #ffebee 50%, #fff8e1 100%); font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent; }

        /* --- é£˜è½é›ªèŠ±åŠ¨ç”» --- */
        #snowflakes { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; overflow: hidden; }
        .snowflake { position: absolute; color: #fff; font-size: 20px; opacity: 0.8; animation: fall linear infinite; text-shadow: 0 0 5px rgba(0,0,0,0.1); }
        @keyframes fall { 0% { transform: translateY(-10px) rotate(0deg); } 100% { transform: translateY(100vh) rotate(360deg); } }

        /* --- é¡¶éƒ¨è£…é¥°å½©å¸¦ --- */
        #ribbon { position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, var(--spring-red), var(--spring-gold), var(--spring-red), var(--spring-gold)); z-index: 6; }

        /* --- ç¯ç¬¼è£…é¥° --- */
        .lantern { position: fixed; font-size: 40px; z-index: 4; animation: swing 3s ease-in-out infinite; filter: drop-shadow(0 0 10px rgba(255, 193, 7, 0.5)); }
        .lantern-left { top: 20px; left: 10px; }
        .lantern-right { top: 20px; right: 10px; }
        @keyframes swing { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        
        /* äº¤äº’ä¿®å¤ */
        input { -webkit-user-select: text !important; user-select: text !important; }

        /* --- UI å®¹å™¨ --- */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        /* é¡¶éƒ¨æ•°æ®æ  */
        .hud-header { position: absolute; top: 0; left: 0; width: 100%; padding: 50px 20px 0; box-sizing: border-box; display: flex; justify-content: space-between; align-items: flex-start; pointer-events: auto; }
        .score-container { text-align: left; }
        .score-val { font-size: 56px; font-weight: 800; color: var(--spring-red); line-height: 1; text-shadow: 0 2px 10px rgba(211, 47, 47, 0.3); font-style: italic; }
        .score-label { font-size: 12px; color: #d32f2f; letter-spacing: 2px; text-transform: uppercase; margin-top: 5px; font-weight: bold; }

        .lives-badge { background: rgba(211, 47, 47, 0.1); color: var(--spring-red); border: 2px solid var(--spring-red); padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }

        /* å®Œç¾è·³è·ƒç‰¹æ•ˆ - æ˜¥èŠ‚ç‰ˆ */
        .perfect-text { position: absolute; left: 50%; top: 40%; transform: translate(-50%, -50%); color: var(--spring-gold); font-size: 28px; font-weight: bold; opacity: 0; pointer-events: none; text-shadow: 0 0 10px var(--spring-gold), 0 2px 10px rgba(255, 193, 7, 0.8); animation: perfectGlow 0.8s ease-out forwards; }
        @keyframes perfectGlow {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(0.5) rotate(-5deg); }
            50% { transform: translate(-50%, -50%) scale(1.2) rotate(5deg); }
            100% { opacity: 0; transform: translate(-50%, -150%) scale(1.5) rotate(0deg); }
        }

        /* å¼¹çª—é€šç”¨ - æ˜¥èŠ‚ç‰ˆ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 99; transition: opacity 0.3s; pointer-events: auto; }
        .modal-box { width: 85%; max-width: 340px; background: linear-gradient(180deg, #fff 0%, #fff9e6 100%); border: 3px solid var(--spring-gold); border-radius: 24px; padding: 30px 24px; text-align: center; box-shadow: 0 20px 40px rgba(211, 47, 47, 0.2), 0 0 0 4px rgba(255, 193, 7, 0.2); position: relative; overflow: hidden; }

        .modal-box::before { content: ''; position: absolute; top: -50px; left: -50px; width: 150px; height: 150px; background: radial-gradient(circle, var(--spring-red) 0%, transparent 70%); opacity: 0.1; filter: blur(40px); border-radius: 50%; }

        /* å¼¹çª—ç¦å­—è£…é¥° */
        .modal-box::after { content: 'ç¦'; position: absolute; top: 10px; right: 15px; font-size: 40px; font-weight: bold; color: var(--spring-red); opacity: 0.15; font-family: 'KaiTi', serif; }

        .hidden { opacity: 0; pointer-events: none; }

        h2 { color: var(--spring-red); margin: 0 0 8px; font-size: 26px; letter-spacing: 2px; font-weight: bold; }
        p.sub-text { color: #666; font-size: 13px; margin: 0 0 25px; line-height: 1.5; }

        .reward-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 25px; }
        .reward-card { background: linear-gradient(135deg, #fff9e6 0%, #fff5f5 100%); padding: 10px 5px; border-radius: 12px; border: 2px solid var(--spring-gold); }
        .reward-score { color: var(--spring-red); font-weight: bold; font-size: 14px; margin-bottom: 4px; }
        .reward-name { color: #888; font-size: 10px; }

        input { background: #fff; border: 2px solid var(--spring-gold); color: #333; padding: 14px; width: 100%; border-radius: 12px; font-size: 16px; box-sizing: border-box; outline: none; transition: border 0.3s; text-align: center; letter-spacing: 1px; font-weight: bold; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); }
        input:focus { border-color: var(--spring-red); box-shadow: 0 0 10px rgba(211, 47, 47, 0.2); }
        input::placeholder { color: #bbb; }

        .btn-main { background: linear-gradient(90deg, var(--spring-red) 0%, #ff5722 100%); border: none; width: 100%; padding: 14px; border-radius: 30px; color: #fff; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; box-shadow: 0 8px 20px rgba(211, 47, 47, 0.4); transition: transform 0.1s, box-shadow 0.2s; }
        .btn-main:active { transform: scale(0.96); box-shadow: 0 4px 15px rgba(211, 47, 47, 0.4); }

        .btn-sub { background: transparent; border: 2px solid var(--spring-gold); color: var(--spring-red); width: 100%; padding: 12px; border-radius: 30px; margin-top: 10px; font-size: 14px; cursor: font-weight: bold; }
        .btn-sub:active { background: rgba(255, 193, 7, 0.1); }

        #toast { position: fixed; top: 15%; width: 100%; text-align: center; pointer-events: none; opacity: 0; transition: opacity 0.5s; z-index: 100; }
        .toast-msg { background: linear-gradient(90deg, var(--spring-red), #ff5722); color: #fff; padding: 10px 24px; border-radius: 30px; font-size: 13px; display: inline-block; box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3); font-weight: bold; border: 2px solid var(--spring-gold); }

        /* æ˜¥èŠ‚å¿«ä¹æ¨ªå¹… */
        .spring-banner { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); font-size: 24px; font-weight: bold; color: var(--spring-red); text-shadow: 2px 2px 4px rgba(0,0,0,0.1); z-index: 7; animation: pulse 2s ease-in-out infinite; white-space: nowrap; }
        .spring-banner::before, .spring-banner::after { content: 'ğŸ§§'; margin: 0 10px; }
        @keyframes pulse { 0%, 100% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.05); } }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

    <!-- æ˜¥èŠ‚è£…é¥°å…ƒç´  -->
    <div id="ribbon"></div>
    <div id="snowflakes"></div>
    <div class="lantern lantern-left">ğŸ®</div>
    <div class="lantern lantern-right">ğŸ®</div>
    <div class="spring-banner">æ–°æ˜¥å¿«ä¹ é¾™å¹´å¤§å‰</div>

    <div id="game-canvas"></div>

    <div id="ui-layer">
        <div class="hud-header hidden" id="hud">
            <div class="score-container">
                <div class="score-val" id="score-display">0</div>
                <div class="score-label">Garage Points</div>
            </div>
            <div class="lives-badge">å¤æ´»: <span id="lives-display">2</span></div>
        </div>
        <div id="perfect-effect" class="perfect-text">å®Œç¾ +2</div>
    </div>

    <div id="login-modal" class="modal-overlay">
        <div class="modal-box">
            <h2>ğŸ® æé€Ÿè½¦åº“æ˜¥èŠ‚ç‰ˆ</h2>
            <p class="sub-text">ğŸ§§ è·³ä¸€è·³èµ¢å–ä¸“å±ç§Ÿè½¦æƒç›Š ğŸ§§</p>
            <div class="reward-grid">
                <div class="reward-card"><div class="reward-score">50åˆ†</div><div class="reward-name">10å…ƒåˆ¸</div></div>
                <div class="reward-card"><div class="reward-score">100åˆ†</div><div class="reward-name">9æŠ˜åˆ¸</div></div>
                <div class="reward-card"><div class="reward-score">200åˆ†</div><div class="reward-name">60å…ƒå¡</div></div>
            </div>
            <input type="tel" id="phone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·å¼€å¯è½¦åº“" maxlength="11">
            <button class="btn-main" onclick="Game.login()">ğŸ§¨ å‘è½¦å¥½è¿æ¥</button>
        </div>
    </div>

    <div id="result-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <h2 id="end-title">ğŸ† è¡Œé©¶ç»“æŸ</h2>
            <p class="sub-text">æœ¬æ¬¡æŒ‘æˆ˜å¾—åˆ†</p>
            <div style="font-size: 60px; color: var(--spring-red); font-weight: 800; margin: 10px 0; text-shadow: 0 0 20px rgba(211, 47, 47, 0.3);" id="final-score">0</div>
            
            <div id="revive-block">
                <p style="color:#999; font-size:12px;">å‰©ä½™å¤æ´»æ¬¡æ•°: <span id="revive-count">0</span></p>
                <button class="btn-main" onclick="Game.revive()">ğŸ‹ ä½¿ç”¨å¤æ´»å¡</button>
                <button class="btn-sub" id="btn-follow" onclick="Game.followToRevive()">å…³æ³¨å…¬ä¼—å· (+1å¤æ´»)</button>
            </div>

            <div id="restart-block" class="hidden">
                <button class="btn-main" onclick="Game.restart()">ğŸ”„ é‡æ–°å‘è½¦</button>
            </div>
        </div>
    </div>

    <div id="toast"><div class="toast-msg" id="toast-text"></div></div>

    <script>
        const CONFIG = {
            colors: {
                bg: 0xfff5f5,         // æ˜¥èŠ‚æµ…çº¢èƒŒæ™¯
                platformTop: 0xffffff,
                platformSide: 0xc62828, // æ˜¥èŠ‚çº¢è‰²ç³»ä¾§é¢
                highlight: 0xd32f2f
            },
            cubeSize: 4.5,
            jumpHeight: 3,
            
            // æ‰‹æ„Ÿä¿æŒä¸å˜ (2å€æ—¶é•¿)
            speedCoeff: 0.0125, 
            maxPower: 1600, 
            jumperScaleSpeed: 0.0008, 
            gravity: 0.08
        };

        const Game = {
            state: { score: 0, lives: 2 },
            hasFollowed: false,
            isPlaying: false,
            phase: 'idle',
            
            scene: null, camera: null, renderer: null,
            jumper: null, platforms: [],
            
            power: 0,
            direction: 'x',
            velocity: { y: 0, fwd: 0 },
            cameraOffset: { x: 25, y: 25, z: 25 },
            
            init: function() {
                this.initThree();
                this.initListeners();
                this.initSnowflakes();
                this.animate();
            },

            initThree: function() {
                const width = window.innerWidth;
                const height = window.innerHeight;

                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(CONFIG.colors.bg);
                this.scene.fog = new THREE.Fog(CONFIG.colors.bg, 20, 90);

                const aspect = width / height;
                const d = 16;
                this.camera = new THREE.OrthographicCamera(-d*aspect, d*aspect, d, -d, 1, 1000);
                this.camera.position.set(25, 25, 25);
                this.camera.lookAt(0, 0, 0);

                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(width, height);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                document.getElementById('game-canvas').appendChild(this.renderer.domElement);

                // ç¨å¾®é™ä½ç¯å¢ƒå…‰ï¼Œå¢åŠ é˜´å½±å¯¹æ¯”åº¦
                const ambient = new THREE.AmbientLight(0xffffff, 0.7);
                this.scene.add(ambient);
                
                const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
                dirLight.position.set(20, 40, 30);
                dirLight.castShadow = true;
                dirLight.shadow.mapSize.width = 1024;
                dirLight.shadow.mapSize.height = 1024;
                dirLight.shadow.camera.left = -40;
                dirLight.shadow.camera.right = 40;
                dirLight.shadow.camera.top = 40;
                dirLight.shadow.camera.bottom = -40;
                dirLight.shadow.radius = 2; 
                this.scene.add(dirLight);
                
                const planeGeo = new THREE.PlaneGeometry(300, 300);
                const planeMat = new THREE.ShadowMaterial({ opacity: 0.1, color: 0x000000 });
                const plane = new THREE.Mesh(planeGeo, planeMat);
                plane.rotation.x = -Math.PI / 2;
                plane.position.y = -0.05;
                plane.receiveShadow = true;
                this.scene.add(plane);
            },

            createPlatformTexture: function(carName) {
                const size = 512;
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;
                const ctx = canvas.getContext('2d');

                // æ˜¥èŠ‚æ¸å˜èƒŒæ™¯
                const gradient = ctx.createLinearGradient(0, 0, size, size);
                gradient.addColorStop(0, '#fff9e6');
                gradient.addColorStop(1, '#fff5f5');
                ctx.fillStyle = gradient;
                ctx.fillRect(0,0,size,size);

                // é‡‘è‰²è£…é¥°ç‚¹
                for(let i=0; i<4000; i++){
                    ctx.fillStyle = Math.random()>0.5 ? 'rgba(211, 47, 47, 0.08)' : 'rgba(255, 193, 7, 0.2)';
                    ctx.fillRect(Math.random()*size, Math.random()*size, 2, 2);
                }

                // çº¢è‰²è¾¹æ¡†
                ctx.strokeStyle = '#d32f2f';
                ctx.lineWidth = 12;
                ctx.strokeRect(20, 20, size-40, size-40);

                // é‡‘è‰²å†…åœˆè£…é¥°
                ctx.beginPath();
                ctx.arc(size/2, size/2, 20, 0, Math.PI*2);
                ctx.fillStyle = '#ffc107';
                ctx.fill();

                ctx.beginPath();
                ctx.arc(size/2, size/2, 50, 0, Math.PI*2);
                ctx.strokeStyle = 'rgba(211, 47, 47, 0.3)';
                ctx.lineWidth = 4;
                ctx.stroke();

                ctx.translate(size/2, size/2);
                ctx.rotate(-Math.PI / 4);

                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                ctx.font = 'bold 36px Arial';
                ctx.fillStyle = '#d32f2f';
                ctx.fillText("ğŸ® æé€Ÿè½¦åº“", 0, -80);

                ctx.font = '900 60px sans-serif';
                ctx.fillStyle = '#333';
                ctx.fillText(carName, 0, 0);

                ctx.font = '28px Arial';
                ctx.fillStyle = '#d32f2f';
                ctx.fillText("ç§Ÿè½¦æƒç›ŠåŒº", 0, 80);

                return new THREE.CanvasTexture(canvas);
            },

            createLittleHa: function() {
                if(this.jumper) this.scene.remove(this.jumper);

                this.jumper = new THREE.Group();

                // æ˜¥èŠ‚é…è‰² - çº¢è‰²ä¸ºä¸»
                const bodyMat = new THREE.MeshLambertMaterial({ color: 0xf5f5f5 }); // ç™½è‰²èº«ä½“
                const redMat = new THREE.MeshLambertMaterial({ color: 0xd32f2f }); // çº¢è‰²
                const goldMat = new THREE.MeshLambertMaterial({ color: 0xffc107 }); // é‡‘è‰²
                const blackMat = new THREE.MeshLambertMaterial({ color: 0x333333 });

                const bodyGeo = new THREE.BoxGeometry(0.8, 1, 0.8);
                const body = new THREE.Mesh(bodyGeo, redMat);
                body.position.y = 0.5;
                body.castShadow = true;
                this.jumper.add(body);

                // çº¢è‰²å›´å·¾
                const scarfGeo = new THREE.BoxGeometry(0.9, 0.25, 0.9);
                const scarf = new THREE.Mesh(scarfGeo, goldMat);
                scarf.position.y = 0.85;
                this.jumper.add(scarf);

                const headGeo = new THREE.BoxGeometry(0.9, 0.8, 0.9);
                const head = new THREE.Mesh(headGeo, bodyMat);
                head.position.y = 1.5;
                head.castShadow = true;
                this.jumper.add(head);

                // æ˜¥èŠ‚çº¢è‰²è€³æœµ
                const earGeo = new THREE.BoxGeometry(0.2, 0.35, 0.2);
                const earL = new THREE.Mesh(earGeo, redMat);
                earL.position.set(-0.3, 1.95, 0);
                const earR = new THREE.Mesh(earGeo, redMat);
                earR.position.set(0.3, 1.95, 0);
                this.jumper.add(earL);
                this.jumper.add(earR);

                // çœ¼ç›
                const eyeGeo = new THREE.PlaneGeometry(0.15, 0.15);
                const eyeL = new THREE.Mesh(eyeGeo, blackMat);
                eyeL.position.set(0.46, 1.5, -0.2);
                eyeL.rotation.y = Math.PI / 2;

                const eyeR = new THREE.Mesh(eyeGeo, blackMat);
                eyeR.position.set(0.46, 1.5, 0.2);
                eyeR.rotation.y = Math.PI / 2;

                this.jumper.add(eyeL);
                this.jumper.add(eyeR);

                // æ˜¥èŠ‚å¸½å­
                const hatGeo = new THREE.ConeGeometry(0.5, 0.4, 4);
                const hat = new THREE.Mesh(hatGeo, redMat);
                hat.position.y = 2.1;
                hat.rotation.y = Math.PI / 4;
                this.jumper.add(hat);

                // å¸½å­ä¸Šçš„é‡‘è‰²è£…é¥°
                const hatTopGeo = new THREE.SphereGeometry(0.1, 8, 8);
                const hatTop = new THREE.Mesh(hatTopGeo, goldMat);
                hatTop.position.y = 2.3;
                this.jumper.add(hatTop);

                this.jumper.position.set(0, 1, 0);
                this.scene.add(this.jumper);
            },

            createPerfectEffect: function(x, z) {
                const geo = new THREE.RingGeometry(0.5, 0.8, 32);
                const mat = new THREE.MeshBasicMaterial({ color: 0xffc107, transparent: true, opacity: 0.8, side: THREE.DoubleSide });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.rotation.x = -Math.PI/2;
                mesh.position.set(x, 1.1, z);
                this.scene.add(mesh);
                
                let scale = 1;
                const anim = () => {
                    scale += 0.05;
                    mesh.scale.set(scale, scale, scale);
                    mesh.material.opacity -= 0.03;
                    if (mesh.material.opacity > 0) {
                        requestAnimationFrame(anim);
                    } else {
                        this.scene.remove(mesh);
                    }
                };
                anim();
            },

            spawnPlatform: function(x, z) {
                const names = ["ç»æµå‹è½¿è½¦", "èˆ’é€‚å‹SUV", "å•†åŠ¡åˆ«å…‹", "ç‰¹æ–¯æ‹‰Model3", "ææ°ª001", "ä¿æ—¶æ·911", "æˆ¿è½¦è‡ªé©¾"];
                const name = names[Math.floor(Math.random() * names.length)];
                
                const geometry = new THREE.BoxGeometry(CONFIG.cubeSize, 2, CONFIG.cubeSize);
                
                const topTex = this.createPlatformTexture(name);
                const sideMat = new THREE.MeshLambertMaterial({ color: CONFIG.colors.platformSide });
                const topMat = new THREE.MeshLambertMaterial({ map: topTex });

                const materials = [ sideMat, sideMat, topMat, sideMat, sideMat, sideMat ];
                
                const mesh = new THREE.Mesh(geometry, materials);
                mesh.position.set(x, 0, z);
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                this.scene.add(mesh);
                this.platforms.push(mesh);
                return mesh;
            },

            spawnNext: function() {
                const last = this.platforms[this.platforms.length-1];
                let x = last.position.x;
                let z = last.position.z;
                
                const dist = Math.random() * 6 + 5; 
                
                if (Math.random() > 0.5) {
                    x += dist; 
                    this.direction = 'x';
                } else {
                    z -= dist; 
                    this.direction = 'z';
                }
                
                this.spawnPlatform(x, z);
            },

            startGame: function() {
                this.platforms.forEach(p => this.scene.remove(p));
                this.platforms = [];
                this.state.score = 0;
                document.getElementById('score-display').innerText = 0;
                
                this.spawnPlatform(0, 0); 
                this.spawnNext();         
                this.createLittleHa();    
                
                this.jumper.rotation.y = this.direction === 'x' ? 0 : -Math.PI/2;

                this.camera.position.set(25, 25, 25);
                this.camera.lookAt(0,0,0);
                
                this.isPlaying = true;
                this.phase = 'idle';
            },

            initListeners: function() {
                const el = document.getElementById('game-canvas');
                
                const start = (e) => {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;

                    if(!this.isPlaying || this.phase !== 'idle') return;
                    
                    e.preventDefault(); 
                    this.phase = 'charging';
                    this.power = 0;
                };
                
                const end = (e) => {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;

                    if(!this.isPlaying || this.phase !== 'charging') return;
                    
                    e.preventDefault();
                    this.phase = 'jumping';
                    
                    this.velocity.y = CONFIG.jumpHeight * 0.15;
                    this.velocity.fwd = this.power * CONFIG.speedCoeff;
                    
                    this.velocity.fwd = Math.min(this.velocity.fwd, 1.8); 
                };

                el.addEventListener('mousedown', start);
                el.addEventListener('touchstart', start, {passive:false});
                window.addEventListener('mouseup', end);
                window.addEventListener('touchend', end, {passive:false});
            },

            animate: function() {
                requestAnimationFrame(this.animate.bind(this));
                
                if(!this.isPlaying) {
                    this.renderer.render(this.scene, this.camera);
                    return;
                }

                if(this.phase === 'charging') {
                    if(this.power < CONFIG.maxPower) this.power += 1; 
                    if(this.jumper.scale.y > 0.6) {
                        this.jumper.scale.y -= CONFIG.jumperScaleSpeed;
                    }
                }

                if(this.phase === 'jumping') {
                    if(this.jumper.scale.y < 1) this.jumper.scale.y += 0.05;
                    
                    this.jumper.position.y += this.velocity.y;
                    this.velocity.y -= CONFIG.gravity;
                    
                    if(this.direction === 'x') {
                        this.jumper.position.x += this.velocity.fwd;
                        this.jumper.rotation.z = -this.velocity.y; 
                    } else {
                        this.jumper.position.z -= this.velocity.fwd;
                        this.jumper.rotation.x = -this.velocity.y;
                    }
                    
                    if(this.jumper.position.y <= 1) {
                        this.jumper.position.y = 1;
                        this.jumper.rotation.set(0, this.direction === 'x' ? 0 : -Math.PI/2, 0); 
                        this.phase = 'idle';
                        this.checkLanding();
                    }
                }
                
                if(this.jumper) {
                    const targetX = this.jumper.position.x;
                    const targetZ = this.jumper.position.z;
                    
                    const currentLookAtX = this.camera.position.x - this.cameraOffset.x;
                    const currentLookAtZ = this.camera.position.z - this.cameraOffset.z;
                    
                    const lerpSpeed = 0.08;
                    const newLookX = currentLookAtX + (targetX - currentLookAtX) * lerpSpeed;
                    const newLookZ = currentLookAtZ + (targetZ - currentLookAtZ) * lerpSpeed;
                    
                    this.camera.position.x = newLookX + this.cameraOffset.x;
                    this.camera.position.z = newLookZ + this.cameraOffset.z;
                    this.camera.lookAt(newLookX, 0, newLookZ);
                }

                this.renderer.render(this.scene, this.camera);
            },

            checkLanding: function() {
                const jPos = this.jumper.position;
                const platform = this.platforms[this.platforms.length - 1]; 
                const prevPlatform = this.platforms[this.platforms.length - 2]; 

                const distToCenter = Math.sqrt(
                    Math.pow(jPos.x - platform.position.x, 2) + 
                    Math.pow(jPos.z - platform.position.z, 2)
                );
                
                const distToPrev = prevPlatform ? Math.sqrt(
                    Math.pow(jPos.x - prevPlatform.position.x, 2) + 
                    Math.pow(jPos.z - prevPlatform.position.z, 2)
                ) : 999;

                const limit = CONFIG.cubeSize / 2; 

                if (distToPrev < limit) return; 

                if (distToCenter < limit) {
                    if (distToCenter < 0.8) {
                        this.state.score += 2;
                        this.showPerfectAnim();
                        this.createPerfectEffect(platform.position.x, platform.position.z);
                    } else {
                        this.state.score += 1;
                    }
                    
                    this.updateScore();
                    this.checkRewards();
                    this.spawnNext();
                    
                    this.jumper.rotation.y = this.direction === 'x' ? 0 : -Math.PI/2;

                    if(this.platforms.length > 5) {
                        const old = this.platforms.shift();
                        this.scene.remove(old);
                    }

                } else {
                    const fallAnim = setInterval(() => {
                        this.jumper.position.y -= 0.2;
                        if(this.jumper.position.y < -5) {
                            clearInterval(fallAnim);
                            this.gameOver();
                        }
                    }, 16);
                }
            },

            showPerfectAnim: function() {
                const el = document.getElementById('perfect-effect');
                el.style.animation = 'none';
                el.offsetHeight;
                el.style.animation = 'perfectGlow 0.8s ease-out forwards';
            },

            updateScore: function() {
                document.getElementById('score-display').innerText = this.state.score;
            },

            checkRewards: function() {
                const s = this.state.score;
                if(s === 50) this.showToast("ğŸ‰ è§£é” 10å…ƒä¼˜æƒ åˆ¸");
                if(s === 100) this.showToast("ğŸ‰ è§£é” 9æŠ˜ç§Ÿè½¦åˆ¸");
                if(s === 200) this.showToast("ğŸ† è·å¾— 60å…ƒæ¬¡å¡");
            },

            initSnowflakes: function() {
                const container = document.getElementById('snowflakes');
                const flakes = ['â„', 'â…', 'â†', 'âœ»', 'âœ¼'];

                for(let i = 0; i < 30; i++) {
                    const flake = document.createElement('div');
                    flake.className = 'snowflake';
                    flake.innerHTML = flakes[Math.floor(Math.random() * flakes.length)];
                    flake.style.left = Math.random() * 100 + '%';
                    flake.style.animationDuration = (Math.random() * 5 + 5) + 's';
                    flake.style.animationDelay = (Math.random() * 10) + 's';
                    flake.style.fontSize = (Math.random() * 15 + 15) + 'px';
                    flake.style.color = Math.random() > 0.5 ? '#fff' : '#ffc107';
                    container.appendChild(flake);
                }
            },

            showToast: function(msg) {
                const t = document.getElementById('toast');
                document.getElementById('toast-text').innerText = msg;
                t.style.opacity = 1;
                setTimeout(() => t.style.opacity = 0, 2500);
            },

            login: function() {
                const p = document.getElementById('phone').value;
                if(p.length !== 11) { alert("è¯·è¾“å…¥æ­£ç¡®æ‰‹æœºå·"); return; }
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('hud').classList.remove('hidden');
                this.startGame();
            },

            gameOver: function() {
                this.isPlaying = false;
                document.getElementById('result-modal').classList.remove('hidden');
                document.getElementById('final-score').innerText = this.state.score;
                document.getElementById('revive-count').innerText = this.state.lives;
                
                const reviveArea = document.getElementById('revive-block');
                const restartArea = document.getElementById('restart-block');
                const btnFollow = document.getElementById('btn-follow');
                
                if (this.state.lives > 0) {
                    reviveArea.classList.remove('hidden');
                    restartArea.classList.add('hidden');
                    btnFollow.style.display = this.hasFollowed ? 'none' : 'block';
                } else {
                    if (!this.hasFollowed) {
                        reviveArea.classList.remove('hidden');
                        restartArea.classList.add('hidden');
                        reviveArea.querySelector('button:first-child').style.display = 'none'; 
                        btnFollow.style.display = 'block';
                    } else {
                        reviveArea.classList.add('hidden');
                        restartArea.classList.remove('hidden');
                    }
                }
            },

            revive: function() {
                if(this.state.lives > 0) {
                    this.state.lives--;
                    this.resumeGame();
                }
            },

            followToRevive: function() {
                this.showToast("æ­£åœ¨å‰å¾€å…¬ä¼—å·...");
                setTimeout(() => {
                    this.hasFollowed = true;
                    this.state.lives++;
                    this.showToast("å…³æ³¨æˆåŠŸï¼å¤æ´» +1");
                    this.revive();
                }, 1000);
            },

            resumeGame: function() {
                document.getElementById('result-modal').classList.add('hidden');
                const safePlat = this.platforms[this.platforms.length - 2] || this.platforms[0];
                this.jumper.position.set(safePlat.position.x, 1, safePlat.position.z);
                this.jumper.rotation.set(0, this.direction==='x'?0:-Math.PI/2, 0);
                this.jumper.scale.set(1,1,1);
                this.velocity.y = 0;
                
                this.isPlaying = true;
                this.phase = 'idle';
                this.updateScore();
            },

            restart: function() {
                this.state.lives = 2;
                this.hasFollowed = false;
                document.getElementById('result-modal').classList.add('hidden');
                this.startGame();
            }
        };

        Game.init();

    </script>
</body>
</html>